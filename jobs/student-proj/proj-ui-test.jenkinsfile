pipeline {
  agent {
    label 'workstation'
  }

  environment {
    AWS = credentials('AWS-DEV-KEYS')
    VAULT_PASS = credentials('VAULT_PASS')
    SSH = credentials('CENTOS-KEY')
    NEXUS = credentials('NEXUS')
  }

  stages {

    stage('Clone Repo') {
      steps {
        git credentialsId: 'git', url: 'https://github.com/cheerlavamsi/terraform.git'
      }
    }

    stage('Create Test Env with Terraform') {
      steps {
        ansiColor('xterm') { 
          sh '''
            export AWS_ACCESS_KEY_ID="${AWS_USR}"
            export AWS_SECRET_ACCESS_KEY="${AWS_PSW}"
            export AWS_DEFAULT_REGION="us-east-1"
            export VAULT_PASS=${VAULT_PASS}
            cd Project-01
            make test-apply ${SSH_USR} ${SSH}
          '''
        }
      }
    }

    stage('Deploy New Artifact to Test ENV') {
      steps {
        git credentialsId: 'git', url: 'https://github.com/cheerlavamsi/ansible.git'
        script {
          step ([$class: 'CopyArtifact',
          projectName: 'Ci-PipeLine',
          filter: "url.txt"]);
        }
        sh '''
          URL=$(cat url.txt)
          ansible-playbook -i /tmp/hosts Projects/Studentapp/deploy.yml --extra-vars "ansible_user=root ansible_password=DevOps321" -e URL=$URL -e NEXUS_USR=$NEXUS_USR -e NEXUS_PSW=$NEXUS_PSW
        '''
      }
    }


       
  }

}
